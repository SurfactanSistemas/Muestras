using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using ClassConexion;
using Negocio;
using System.Configuration;
using System.Text.RegularExpressions;

namespace Vista
{
    

    public partial class Muestra : Form
    {
        Conexion CS = new Conexion();
        Terminado Ter = new Terminado();
        Negocio.Muestra M = new Negocio.Muestra();
        DataTable dt;
        string columna = "";

        public Muestra()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            ConfigurationManager.AppSettings["Fecha_Desde"] = TB_Desde.Text;
            ConfigurationManager.AppSettings["Fecha_Hasta"] = TB_Hasta.Text;

            dt = new DataTable();
            dt.Clear();
            dt = M.TraerLista(TB_Desde.Text, TB_Hasta.Text);

            //Se utiliza esta columna para ordenar las fechas.
            dt.Columns.Add("OrdenFecha", typeof(string));

            foreach (DataRow Fila in dt.Rows)
            {
                Fila["OrdenFecha"] = Fila[2].ToString().Substring(3);
            }

            DGV_Muestra.DataSource = dt;

            //LimpiarFechas();

            //Limpio cualquier filtro existente
            (DGV_Muestra.DataSource as DataTable).DefaultView.RowFilter = string.Empty;
        }

        private void button1_Click(object sender, EventArgs e)
        {
        }

        private void BT_Buscar_Click(object sender, EventArgs e)
        {
            try
            {
                ValidarAños();

                ConfigurationManager.AppSettings["Fecha_Desde"] = TB_Desde.Text;
                ConfigurationManager.AppSettings["Fecha_Hasta"] = TB_Hasta.Text;

                dt = new DataTable();
                dt.Clear();
                dt = M.TraerLista(TB_Desde.Text, TB_Hasta.Text);

               

                foreach (DataRow Fila in dt.Rows)
                {
                    Fila["OrdenFecha"] = Fila[2].ToString().Substring(3);
                }

                DGV_Muestra.DataSource = dt;

                //LimpiarFechas();

                //Limpio cualquier filtro existente
                (DGV_Muestra.DataSource as DataTable).DefaultView.RowFilter = string.Empty;
            }
            catch (Exception Err)
            {                
                MessageBox.Show(Err.Message, "Error",MessageBoxButtons.OK,MessageBoxIcon.Error);  
            }            
        }

        private void ValidarAños()
        {
            if (TB_Desde.Text == "") throw new Exception("No se ha ingresado la fecha Inicial");
            if (TB_Hasta.Text == "") throw new Exception("No se ha ingresado la fecha Final");

            if (!Regex.IsMatch(TB_Desde.Text, "^(19|20)[0-9][0-9]") || !Regex.IsMatch(TB_Hasta.Text, "^(19|20)[0-9][0-9]")) throw new Exception("Unos de los valores ingresados no corresponde a un año valido");
            if (int.Parse(TB_Hasta.Text) < int.Parse(TB_Desde.Text)) throw new Exception("La fecha desde no puede ser mayor a la fecha hasta");

        }

        

        private void LimpiarFechas()
        {
            TB_Desde.Text = "";
            TB_Hasta.Text = "";
        }

        private void button7_Click(object sender, EventArgs e)
        {
            Button btnSender = (Button)sender;
            Point ptLowerLeft = new Point(0, btnSender.Height);
            ptLowerLeft = btnSender.PointToScreen(ptLowerLeft);
            CMS_Filtros.Show(ptLowerLeft);
            BT_Filtrar.Text = "Filtrar";
            TBFiltro.Text = "";
            
            
        }

        private void BT_Filtrar_Click(object sender, EventArgs e)
        {
            if (BT_Filtrar.Text == "Filtrar")
            {
                (DGV_Muestra.DataSource as DataTable).DefaultView.RowFilter = string.Format("CONVERT(" + columna + ", System.String) like '%{0}%'", TBFiltro.Text);
                //P_Filtrado.Visible = false;
                //TBFiltro.Text = "";
                BT_Filtrar.Text = "Limp. Filtro";
            }
            else
            {
                ConfigurationManager.AppSettings["Fecha_Desde"] = TB_Desde.Text;
                ConfigurationManager.AppSettings["Fecha_Hasta"] = TB_Hasta.Text;

                dt = new DataTable();
                dt.Clear();
                dt = M.TraerLista(TB_Desde.Text, TB_Hasta.Text);

                DGV_Muestra.DataSource = dt;

                //LimpiarFechas();

                //Limpio cualquier filtro existente
                (DGV_Muestra.DataSource as DataTable).DefaultView.RowFilter = string.Empty;

                P_Filtrado.Visible = false;
                TBFiltro.Text = "";
                BT_Filtrar.Visible = true;
                
            }
        }

        private void pedidoToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Pedido";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;

        }

        private void fechaToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Fecha";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void codigoToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Codigo";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }
        
        private void HabilitarPanelFiltrado()
        {
            P_Filtrado.Visible = true;
            TBFiltro.Focus();
        }

        //private void CheckEnter(object sender, System.Windows.Forms.KeyPressEventArgs e)
        //{
           // if (e.KeyChar == (char)13)

               // TB_Hasta.Focus();
        //}

       private void TB_Desde_KeyDown(object sender, KeyEventArgs e)
        {
            //PresionarBotonBuscar(e);
        if(e.KeyCode == Keys.Enter)
            TB_Hasta.Focus();
            
        }

        private void TB_Hasta_KeyDown(object sender, KeyEventArgs e)
        {
            PresionarBotonBuscar(e);
            if (e.KeyCode == Keys.Enter)
                BT_Buscar.Focus();
            
        }

        private void TBFiltro_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                BT_Filtrar.PerformClick();
                e.SuppressKeyPress = true;
                e.Handled = true;
            }
        }

        private void PresionarBotonBuscar( KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                BT_Buscar.PerformClick();
                e.SuppressKeyPress = true;
                e.Handled = true;
            }
        }

        private void descripcionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Nombre";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void cantidadToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Cantidad";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void nombreParaElClienteToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "DescriCliente";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void óbservacionesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Observaciones";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            try
            {
                //Armo el datatable
                if (DGV_Muestra.SelectedRows.Count == 0) throw new Exception("No hay filas seleccionadas");

                DataTable dt = new DataTable();
                foreach (DataGridViewColumn column in DGV_Muestra.Columns)
                    dt.Columns.Add(column.Name, typeof(string));
                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    dt.Rows.Add();
                    for (int j = 0; j < DGV_Muestra.Columns.Count; j++)
                    {
                        dt.Rows[i][j] = DGV_Muestra.SelectedRows[i].Cells[j].Value;
                    }
                }

                Exportar exportar = new Exportar(dt);
                exportar.ShowDialog();
            }
            catch (Exception err)
            {
                MessageBox.Show(err.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        }

        private void button6_Click(object sender, EventArgs e)
        {
            DialogResult dialogResult = MessageBox.Show("¿Estas seguro que quieres salir?", "Confirmacion salir",
                                MessageBoxButtons.YesNo);  
            if (dialogResult == DialogResult.Yes){
                Close();
            }
        }

        private void BtEtiquetas_Click(object sender, EventArgs e)
        {
            try
            {
                //Valido que se hayan seleccionado registros
                if (DGV_Muestra.SelectedRows.Count == 0) throw new Exception("No hay filas seleccionadas");
                if (DGV_Muestra.SelectedRows.Count > 1) throw new Exception("Solo se puede seleccionar una Muestra");
                //creo el datatable
                DataTable dt = new DataTable();

                AgregarColumnas(dt);

                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    DataRow newRow = dt.NewRow();
                    newRow["NombreEmpresa"] = "SURFACTAN S.A.";
                    newRow["Nombre"] = DGV_Muestra.SelectedRows[i].Cells["Nombre"].Value.ToString();
                    newRow["Codigo"] = DGV_Muestra.SelectedRows[i].Cells["Codigo"].Value.ToString();
                    newRow["DescriCliente"] = DGV_Muestra.SelectedRows[i].Cells["DescriCliente"].Value.ToString();
                    newRow["Razon"] = DGV_Muestra.SelectedRows[i].Cells["Razon"].Value.ToString();
                    newRow["Fecha"] = "Fecha: "+DateTime.Now.ToShortDateString();
                    newRow["Direccion_1"] = "MALVINAS ARGENTINAS 4589 (1644) VICTORIA";
                    newRow["Direccion_2"] = "BS.AS. 4714-4097/4085 surfac@surfactan.com";

                    string codigoOri = DGV_Muestra.SelectedRows[i].Cells["Codigo"].Value.ToString();
                    //string codigo = codigoOri.Substring(0, 12);

                    //Me fijo si empieza con PT de Producto Terminado y sino dejo todo vacio
                    if (codigoOri.Substring(0, 2) == "PT")
                    {
                        string codigo = codigoOri.Substring(0, 12);

                        DataRow datarow = Ter.ListarPeligroso(codigo);
                        newRow["Clase"] = "Clase: "+datarow[0];
                        newRow["Intervencion"] ="Guia: " +datarow[1];
                        newRow["Naciones"] = "O.N.U: " + datarow[2];
                    }
                    else
                    {
                        newRow["Clase"] = "";
                        newRow["Intervencion"] = "";
                        newRow["Naciones"] = "";
                    }

                    dt.Rows.Add(newRow);

                }

                Etiquetas etiquetas = new Etiquetas(dt);
                etiquetas.ShowDialog();
            }
            catch (Exception err)
            {
                MessageBox.Show(err.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        }

        private void BtRemito_Click(object sender, EventArgs e)
        {
            try
            {
                DataTable dt = new DataTable();
                List<string> sinEnsayo = new List<string>();
                List<string> errorLote = new List<string>();
                List<string> peligroI = new List<string>();
                List<string> peligroII = new List<string>();

                int cantidad = (DGV_Muestra.SelectedRows.Count - 1);
                string cliente = DGV_Muestra.SelectedRows[cantidad].Cells[7].Value.ToString(); //Cliente

                //Filtro para clientes identicos
                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    if (DGV_Muestra.SelectedRows[i].Cells[7].Value.ToString() != cliente) {
                        throw new Exception("Los clientes son distintos");
                    }
                }

                //Verifico que se ML y valor medio mayor a 100 (Verifico que se haya hecho actualizar laboratiori)
                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    int valor = int.Parse(DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString().Substring(3, 3));

                    if (DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString().StartsWith("ML") &&
                        valor >= 100) {
                            string Id = DGV_Muestra.SelectedRows[i].Cells[0].Value.ToString();
                            if (!CS.VerificarEnsayo2(Id)) throw new Exception("La muestra " + DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString() + " no posee ensayo");
                            //sinEnsayo.Add(DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString());
                    }
                }

                //Verifico que no tengan número de remito
                string numero_remito = DGV_Muestra.SelectedRows[0].Cells[10].Value.ToString();

                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    if (DGV_Muestra.SelectedRows[i].Cells[10].Value.ToString() != numero_remito) {
                            throw new Exception("El numero de remito es diferente");
                        }
                }

                if (numero_remito != "")
                {
                    dt = CS.BuscarListaRemito(numero_remito);

                    DataRow datacliente1 = CS.BuscarCliente(cliente);

                    string CodClient1 = datacliente1[0].ToString();
                    string DirClient1 = datacliente1[1].ToString();
                    string LocalidadClient1 = datacliente1[2].ToString();
                    string Cuit1 = datacliente1[3].ToString();
                    string DirEntrega1 = datacliente1[4].ToString();
                    ImpreRemito impre_1 = new ImpreRemito(dt, DirEntrega1, CodClient1, DirClient1, LocalidadClient1, Cuit1, cliente);
                    impre_1.ShowDialog();
                    goto finalizado;
                    //goto Error;
                    
                                    
                }

                //Se valido todo ahora se va a modificar la/s base/s                
                int[] Lotes = new int[DGV_Muestra.SelectedRows.Count];

                string[,] Peligroso = new string[DGV_Muestra.SelectedRows.Count, 2];

                string[] Codigos = new string[DGV_Muestra.SelectedRows.Count]; 

                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    string cod = DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString();

                    if(DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString().Length < 12)
                    {
                        string codigo = cod.Substring(0, 2) + "-00" + cod.Substring(3, 7);
                        cod = codigo;
                    }
                    Codigos[i] = cod;
                    int Id = int.Parse(DGV_Muestra.SelectedRows[i].Cells[0].Value.ToString());
                    string pedido = DGV_Muestra.SelectedRows[i].Cells[1].Value.ToString();

                    //VERIFICO QUE NO SEA ML PARA QUE SE BUSQUE EL LOTE

                    if (!DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString().StartsWith("ML"))
                    {
                        int Lote1 = int.Parse(CS.BuscarLote1(cod, pedido));
                        if (Lote1 == 0) throw new Exception("La muestra " + DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString() + " no posee lote");
                        //errorLote.Add(DGV_Muestra.SelectedRows[i].Cells[3].Value.ToString());
                        Lotes[i] = Lote1;
                    }

                    DataRow datarow = CS.ListarPeligroso(Id);

                    Peligroso[i, 0] = datarow[0].ToString();
                    Peligroso[i, 1] = datarow[1].ToString();
                    

                    
                }
                
                
                //cargo el nombre cliente
                DataRow datacliente = CS.BuscarCliente(cliente);

                string CodClient = datacliente[0].ToString();
                string DirClient = datacliente[1].ToString();
                string LocalidadClient = datacliente[2].ToString();
                string Cuit = datacliente[3].ToString();
                string DirEntrega = datacliente[4].ToString();

                string datos = numero_remito + ";" + cliente;
                AgregarColumnasRemito(dt);

                

                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    DataRow newRow = dt.NewRow();
                    newRow["Descripcion"] = DGV_Muestra.SelectedRows[i].Cells["Nombre"].Value.ToString();
                    newRow["Cantidad"] = DGV_Muestra.SelectedRows[i].Cells["Cantidad"].Value.ToString();
                    newRow["Muestra"] = DGV_Muestra.SelectedRows[i].Cells["Id"].Value.ToString();
                    newRow["Partida"] = Lotes[i];
                    newRow["Pedido"] = DGV_Muestra.SelectedRows[i].Cells["Pedido"].Value.ToString();
                    newRow["Codigo"] = Codigos[i];
                    newRow["Codigo_Original"] = DGV_Muestra.SelectedRows[i].Cells["Codigo"].Value.ToString();
                    newRow["Peligroso"] = Peligroso[i, 0];
                    newRow["PeligrosoII"] = Peligroso[i, 1];

                    dt.Rows.Add(newRow);
                }

                
                Remito remito = new Remito(datos, dt, errorLote, sinEnsayo, DirEntrega, CodClient, DirClient, LocalidadClient, Cuit, cliente);
                remito.ShowDialog();
                
            }
                            
            catch (Exception err)
            {
                
                MessageBox.Show(err.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        finalizado: ;
           
        }

        private void terminar()
        {
            throw new NotImplementedException();
        }

        private void AgregarColumnasRemito(DataTable dt)
        {
            dt.Columns.Add("Descripcion", typeof(string));
            dt.Columns.Add("Cantidad", typeof(string));
            dt.Columns.Add("Muestra", typeof(string));
            dt.Columns.Add("Partida", typeof(string));
            dt.Columns.Add("Pedido", typeof(string));
            dt.Columns.Add("Codigo", typeof(string));
            dt.Columns.Add("Codigo_Original", typeof(string));
            dt.Columns.Add("Peligroso", typeof(string));
            dt.Columns.Add("PeligrosoII", typeof(string));
        }

        

        private void AgregarColumnas(DataTable dt)
        {
            dt.Columns.Add("NombreEmpresa", typeof(string));
            dt.Columns.Add("Nombre", typeof(string));
            dt.Columns.Add("Codigo", typeof(string));
            dt.Columns.Add("DescriCliente", typeof(string));
            dt.Columns.Add("Razon", typeof(string));
            dt.Columns.Add("Fecha", typeof(string));
            dt.Columns.Add("Direccion_1", typeof(string));
            dt.Columns.Add("Direccion_2", typeof(string));
            dt.Columns.Add("Clase", typeof(string));
            dt.Columns.Add("Intervencion", typeof(string));
            dt.Columns.Add("Naciones", typeof(string));
        }

        private void BtImpresion_Click(object sender, EventArgs e)
        {
            try
            {
                //Armo el datatable
                if (DGV_Muestra.SelectedRows.Count == 0) throw new Exception("No hay filas seleccionadas");

                DataTable dt = new DataTable();
                foreach (DataGridViewColumn column in DGV_Muestra.Columns)
                    dt.Columns.Add(column.Name, typeof(string));
                for (int i = 0; i < DGV_Muestra.SelectedRows.Count; i++)
                {
                    dt.Rows.Add();
                    for (int j = 0; j < DGV_Muestra.Columns.Count; j++)
                    {
                        dt.Rows[i][j] = DGV_Muestra.SelectedRows[i].Cells[j].Value;
                    }
                }

                Impresion impresion = new Impresion(dt);
                impresion.ShowDialog();
                
            }
            catch (Exception err)
            {
                MessageBox.Show(err.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        }

        private void BtActLaborat_Click(object sender, EventArgs e)
        {
            try
            {
                if (DGV_Muestra.SelectedRows.Count == 0)
                    throw new Exception("No hay filas seleccionadas");
                if (DGV_Muestra.SelectedRows.Count > 1)
                    throw new Exception("Se seleccionaron mas de una fila");
                if (!DGV_Muestra.SelectedRows[0].Cells["Codigo"].Value.ToString().StartsWith("ML"))
                    throw new Exception("La muestra seleccionada no es una Muestra de Laboratorio");

                //creo el datatable
                DataTable dt = new DataTable();

                dt.Columns.Add("Id", typeof(string));
                dt.Columns.Add("Codigo", typeof(string));
                dt.Columns.Add("Ensayo", typeof(string));
                dt.Columns.Add("Nombre", typeof(string));
                dt.Columns.Add("Fecha", typeof(string));
                dt.Columns.Add("Cantidad", typeof(string));

                DataRow row = dt.NewRow();
                //Estos datos que tomo estan bien o me tengo que fijar en ensayo2 y cantidad2? 
                row["Id"] = DGV_Muestra.SelectedRows[0].Cells["Id"].Value.ToString();
                row["Codigo"] = DGV_Muestra.SelectedRows[0].Cells["Codigo"].Value.ToString();
                row["Ensayo"] = DGV_Muestra.SelectedRows[0].Cells["CodigoConf"].Value.ToString();
                row["Nombre"] = DGV_Muestra.SelectedRows[0].Cells["Nombre"].Value.ToString();
                row["Fecha"] = DateTime.Now.ToShortDateString();
                row["Cantidad"] = DGV_Muestra.SelectedRows[0].Cells["Cantidad2"].Value.ToString();

                dt.Rows.Add(row);

                ActLab actlab = new ActLab(dt);
                actlab.ShowDialog();
                
                ActualizarGridView();
            }
            catch (Exception err)
            {
                MessageBox.Show(err.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        }

        private void ActualizarGridView()
        {
            int index = DGV_Muestra.SelectedRows[0].Index; 
            TB_Desde.Text = ConfigurationManager.AppSettings["Fecha_Desde"];
            TB_Hasta.Text = ConfigurationManager.AppSettings["Fecha_Hasta"];
            BT_Buscar.PerformClick();
            DGV_Muestra.CurrentCell = DGV_Muestra.Rows[index].Cells[1];
            DGV_Muestra.Rows[index].Selected= true;
        }

        private void DGV_Muestra_KeyDown(object sender, KeyEventArgs e)
        {
            switch (e.KeyCode)
            {
                case Keys.F4:
                    BtActLaborat.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
                case Keys.F5:
                    BtExportar.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
                case Keys.F6:
                    BtEtiquetas.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
                case Keys.F8:
                    BtRemito.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
                case Keys.F9:
                    BtImpresion.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
                case Keys.F10:
                    BtFin.PerformClick();
                    e.SuppressKeyPress = true;
                    e.Handled = true;
                    break;
            }
        }

        private void clienteToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Razon";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void remitoToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "Remito";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void hojaDeRutaToolStripMenuItem_Click(object sender, EventArgs e)
        {
            columna = "HojaRuta";
            HabilitarPanelFiltrado();
            LBFiltro.Text = columna;
        }

        private void DGV_Muestra_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            
        }

        private void DGV_Muestra_Sorted(object sender, EventArgs e)
        {
            //DGV_Muestra.Columns[19].SortMode = DataGridViewColumnSortMode.Automatic;
            DGV_Muestra.Sort(DGV_Muestra.Columns["OrdenFecha"], ListSortDirection.Ascending);
            
                
        }

        private void LBFiltro_Click(object sender, EventArgs e)
        {

        }

      

        

        

        

       
    }
}
